# ğŸ›¡ï¸ SafeTalk-MPC: Semantic-to-MPC with Safety Shield

**SafeTalk-MPC** æ˜¯ä¸€ä¸ªç»“åˆ **è‡ªç„¶è¯­è¨€è¯­ä¹‰ (Semantic)** ä¸ **æ¨¡å‹é¢„æµ‹æ§åˆ¶ (MPC)** çš„æ¡†æ¶ã€‚  
å®ƒæ”¯æŒç”¨æˆ·ç›´æ¥ç”¨è‡ªç„¶è¯­è¨€æŒ‡ä»¤ï¼ˆå¦‚ *â€œç»•éšœæ›´ä¿å®ˆï¼ŒæŠŠå®‰å…¨åŠå¾„æ”¹ä¸º 0.6 ç±³â€*ï¼‰ä¿®æ”¹ **MPC ä¼˜åŒ–é—®é¢˜ (OCP)**ï¼Œç”± **è¯­ä¹‰ç¼–è¯‘å™¨ (Semantic Compiler)** è‡ªåŠ¨è½¬æ¢ä¸º JSON è¡¥ä¸å¹¶åº”ç”¨åˆ°ä»»åŠ¡ DSLã€‚  
åŒæ—¶ï¼Œ**å®‰å…¨ç›¾ (Safety Shield)** ä¿è¯äº†è½¨è¿¹çš„å®‰å…¨æ€§ä¸å¯è¡Œæ€§ï¼Œå³ä½¿ LLM ç”Ÿæˆçš„æŒ‡ä»¤å­˜åœ¨é£é™©ï¼Œä¹Ÿèƒ½è‡ªåŠ¨å…œåº•ã€‚

è¯¥é¡¹ç›®æ—¢æ”¯æŒ **ä»¿çœŸç¯å¢ƒéªŒè¯**ï¼Œä¹Ÿæ”¯æŒ **çœŸå®æœºå™¨äººï¼ˆRDK X5 ç§»åŠ¨å¹³å°ï¼‰å®è½¦éƒ¨ç½²**ï¼Œä¸ºç§‘ç ”å®éªŒã€è®ºæ–‡å‘è¡¨å’Œæ•™å­¦æ¼”ç¤ºæä¾›äº†å¼€æºåŸºå‡†ã€‚

---

## âœ¨ åˆ›æ–°ç‚¹äº®ç‚¹

### ğŸ”¹ è¯­ä¹‰ç¼–è¯‘å™¨ (Semantic Compiler)
- **åŠŸèƒ½**ï¼šè‡ªç„¶è¯­è¨€ â†’ DSL JSON Patch â†’ è‡ªåŠ¨åˆæˆ MPC é—®é¢˜ã€‚
- **æ”¯æŒä¿®æ”¹**ï¼šç›®æ ‡ç‚¹ã€é¿éšœåŠå¾„ã€æƒé‡ã€é¢„æµ‹æ­¥é•¿ã€æ§åˆ¶çº¦æŸç­‰ã€‚
- **åˆ›æ–°**ï¼šå®ç°äº†å…¨è‡ªåŠ¨è¯­ä¹‰åˆ°ä¼˜åŒ–é—®é¢˜çš„è½¬æ¢ï¼Œæ— éœ€äººå·¥æ”¹é…ç½®ã€‚

### ğŸ”¹ å®‰å…¨ç›¾ (Safety Shield)
- ä¸‰ç§æ¨¡å¼ï¼š**ç¡¬çº¦æŸ / è½¯çº¦æŸ / æ··åˆçº¦æŸ**ã€‚
- å½“ LLM ç”Ÿæˆä¸åˆç†å‚æ•°æ—¶ï¼ŒShield è‡ªåŠ¨ä¿®æ­£ï¼Œä¿è¯å®‰å…¨ä¼˜å…ˆã€‚
- **åˆ›æ–°**ï¼šè¯­è¨€é©±åŠ¨ä¸‹çš„é²æ£’ MPC æ¡†æ¶ã€‚

### ğŸ”¹ åå›é€€çº¦æŸ (No-Backtrack)
- é¿å…è½¨è¿¹å‡ºç°â€œå›æ‹‰/å€’é€€â€ã€‚
- **åˆ›æ–°**ï¼šå¼ºåˆ¶å•è°ƒå‰è¿›ï¼Œæ›´ç¬¦åˆç›´è§‰å’ŒçœŸå®æœºå™¨äººéœ€æ±‚ã€‚

### ğŸ”¹ è‡ªé€‚åº”é™é€Ÿ (Speed Cap)
- è¿œç¦»ç›®æ ‡æ—¶åŠ é€Ÿï¼Œæ¥è¿‘ç›®æ ‡æ—¶å‡é€Ÿã€‚
- **åˆ›æ–°**ï¼šå¹³ç¨³é€¼è¿‘ç›®æ ‡ï¼Œé¿å…è¿‡å†²ã€‚

### ğŸ”¹ ç»ˆç«¯ç›’çº¦æŸ (Terminal Box)
- åœ¨ç›®æ ‡ç‚¹é™„è¿‘å®šä¹‰ä¸€ä¸ªæ”¶æ•›ç›’ã€‚
- è¦æ±‚è¿›å…¥æ­¤åŒºåŸŸå¹¶ä½é€Ÿåœè½¦ã€‚
- **åˆ›æ–°**ï¼šä¿è¯â€œåˆ°ç‚¹ä¸”åœä½â€çš„ç¨³å®šæ€§ã€‚

### ğŸ”¹ é£é™©è‡ªé€‚åº” (Risk-Adaptive)
- æ ¹æ® **é£é™©ç­‰çº§ (low/med/high)** è‡ªåŠ¨è°ƒæ•´å®‰å…¨åŠå¾„ã€é¢„æµ‹æ­¥é•¿ã€è½¬è§’èŒƒå›´ã€‚
- **åˆ›æ–°**ï¼šè¯­ä¹‰å±‚é¢å¯¹ MPC é…ç½®çš„å…¨å±€è°ƒä¼˜ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1) å…‹éš†ä»“åº“ & å®‰è£…ä¾èµ–
```bash
git clone https://github.com/RiseBun/SafeTalk-MPC.git
cd SafeTalk-MPC/sem2mpc
conda create -n mpcenv python=3.10 -y
conda activate mpcenv
pip install -r requirements.txt
```

### 2) è¿è¡ŒåŸºçº¿å®éªŒ
```bash
python -m sim.sim_runner dsl/example_task_curve_01.json --out exp/base --llm none
```

è‡ªåŠ¨ç”Ÿæˆï¼š
- `exp/base_result.png` (é™æ€è½¨è¿¹å›¾)  
- `exp/base_anim.mp4` (è½¨è¿¹åŠ¨ç”»)  
- `exp/base_metrics.json` (æŒ‡æ ‡æ–‡ä»¶)  

### 3) ä½¿ç”¨è‡ªç„¶è¯­è¨€ä¿®æ”¹ä»»åŠ¡ï¼ˆè¯­ä¹‰ç¼–è¯‘å™¨ï¼‰
```powershell
# PowerShell ç¤ºä¾‹ (Here-String)
$instr = @'
ç»•éšœæ›´ä¿å®ˆï¼ŒæŠŠå®‰å…¨åŠå¾„åŠ åˆ° 0.6 ç±³
'@
python -m sim.sim_runner dsl/base.json $instr --llm ollama --model qwen2.5:7b --out exp/E1 --save-llm
```

å°†è‡ªåŠ¨ç”Ÿæˆï¼š
- `last_patch.json` â†’ JSON è¡¥ä¸  
- `_tmp_task.json` â†’ åº”ç”¨åçš„ DSL  
- è½¨è¿¹å›¾ä¸åŠ¨ç”»  

### 4) ä½¿ç”¨ç¦»çº¿è¡¥ä¸ï¼ˆæ— éœ€ LLMï¼‰
```bash
echo "{ \"obstacle\": { \"radius\": 0.6 } }" > patch/I1.json
python -m sim.sim_runner dsl/base.json patch/I1.json --out exp/I1 --llm none
```

---

## ğŸ§ª å¯¹ç…§å®éªŒè®¾è®¡ï¼ˆéªŒè¯è¯­ä¹‰ç¼–è¯‘å™¨ä½œç”¨ï¼‰

ä¸‹è¡¨å±•ç¤ºäº†è‡ªç„¶è¯­è¨€æŒ‡ä»¤ä¸æ‰‹å·¥è¡¥ä¸çš„å¯¹åº”å…³ç³»ï¼š

| å®éªŒç¼–å· | è‡ªç„¶è¯­è¨€æŒ‡ä»¤ (LLM) | æ‰‹å·¥è¡¥ä¸ JSON | é¢„æœŸå˜åŒ– |
|---|---|---|---|
| E1 | ç»•éšœæ›´ä¿å®ˆï¼ŒæŠŠå®‰å…¨åŠå¾„æ”¹ä¸º 0.6 ç±³ | `{"obstacle":{"radius":0.6}}` | min_obstacle_distance â†‘ |
| E2 | æ›´å¼ºè°ƒå¹³æ»‘æ§åˆ¶ï¼ŒæŠŠ u_rate_weight æé«˜åˆ° 1.0 | `{"u_rate_weight":1.0}` | æ§åˆ¶æ›´å¹³æ»‘ï¼Œend_err â†‘ |
| E3 | æ›´é è¿‘ç›®æ ‡ç‚¹åœè½¦ï¼ŒæŠŠ terminal_velocity æåˆ° 60 | `{"weights":{"terminal_velocity":60}}` | åœè½¦æ›´ç¨³ï¼Œend_err â†“ |
| E4 | ç¼©çŸ­é¢„æµ‹æ­¥é•¿åˆ° 120 | `{"horizon":120}` | æ±‚è§£æ›´å¿« |
| E5 | å¯ç”¨ä¸­ç‚¹å¼•å¯¼ | `{"insert_midpoint":true}` | ç»•éšœè·¯å¾„æ›´åœ†æ»‘ |
| E6 | é è¿‘ç›®æ ‡æ›´æ…¢ï¼šv_near=0.18, v_far=1.0 | `{"speed_cap":{"v_near":0.18,"v_far":1.0}}` | æ›´æ…¢æ”¶æ•›ï¼Œæ›´å¹³æ»‘ |

**å¦‚ä½•éªŒè¯è¯­ä¹‰ç¼–è¯‘å™¨ç”Ÿæ•ˆï¼Ÿ**
1. è¿è¡Œè‡ªç„¶è¯­è¨€æŒ‡ä»¤ â†’ æ£€æŸ¥ `last_patch.json` æ˜¯å¦ä¸ºæ­£ç¡®çš„ JSON è¡¥ä¸ã€‚  
2. å¯¹æ¯”è‡ªç„¶è¯­è¨€ä¸æ‰‹å·¥è¡¥ä¸çš„ç»“æœ (`*_metrics.json` + åŠ¨ç”»)ã€‚  
3. è‹¥ä¸¤è€…ä¸€è‡´ï¼Œè¯´æ˜è¯­ä¹‰ç¼–è¯‘å™¨å‘æŒ¥äº†ä½œç”¨ã€‚  

---

## ğŸ“‚ é¡¹ç›®ç»“æ„
```plaintext
SafeTalk-MPC/
â”œâ”€â”€ sem2mpc/
â”‚   â”œâ”€â”€ compiler/      # DSL è§£æ & OCP æ„å»º
â”‚   â”œâ”€â”€ semantics/     # è¯­ä¹‰ç¼–è¯‘å™¨ & LLM Provider
â”‚   â”œâ”€â”€ sim/           # ä»¿çœŸä¸å¯è§†åŒ–
â”‚   â””â”€â”€ ...
â”œâ”€â”€ dsl/               # ä»»åŠ¡ DSL (JSON)
â”‚   â”œâ”€â”€ base.json
â”‚   â””â”€â”€ example_task_curve_01.json
â”œâ”€â”€ patch/             # JSON è¡¥ä¸ (å®éªŒæ—¶ç”¨)
â”œâ”€â”€ exp/               # å®éªŒè¾“å‡º (å¿½ç•¥è¿½è¸ª)
â”œâ”€â”€ README.md
â””â”€â”€ requirements.txt
```

---

## ğŸ§¹ .gitignore å»ºè®®
```gitignore
# å®éªŒä¸ä¸´æ—¶æ–‡ä»¶
exp/
patch/
*_metrics.json
*_result.png
*_anim.mp4
last_patch.json
_tmp_task.json
llm_logs/

# Python ç¼“å­˜
__pycache__/
*.pyc
*.pyo
*.pyd
```

---

## ğŸ“Š æŒ‡æ ‡è¯´æ˜
- `end_position_error` â†’ æœ«ç«¯è¯¯å·®ï¼ˆä¸ç›®æ ‡ç‚¹çš„è·ç¦»ï¼Œè¶Šå°è¶Šå¥½ï¼‰  
- `min_obstacle_distance` â†’ æœ€å°éšœç¢ç‰©è·ç¦»ï¼ˆåº” â‰¥ å®‰å…¨åŠå¾„ï¼‰  
- `solve_time_sec` â†’ å•æ¬¡æ±‚è§£æ—¶é—´ï¼ˆå¯ç”¨äº horizon å¯¹æ¯”ï¼‰  

---

## ğŸ“– å¼•ç”¨
```bibtex
@misc{SafeTalkMPC2025,
  author = {RiseBun},
  title = {SafeTalk-MPC: Semantic-to-MPC with Safety Shield},
  year = {2025},
  publisher = {GitHub},
  howpublished = {\url{https://github.com/RiseBun/SafeTalk-MPC}}
}
```

---

## ğŸ† æ€»ç»“
- å»ºç«‹äº† **è‡ªç„¶è¯­è¨€ â†’ JSON Patch â†’ MPC ä¼˜åŒ–é—®é¢˜** çš„å…¨æµç¨‹é—­ç¯ã€‚  
- æå‡ºäº† **å®‰å…¨ç›¾** ä¸ **åå›é€€ / è‡ªé€‚åº”é™é€Ÿ / ç»ˆç«¯ç›’** ç­‰ä¸€ç³»åˆ—åˆ›æ–°çº¦æŸã€‚  
- æä¾›äº† **è‡ªç„¶è¯­è¨€ vs æ‰‹å·¥ JSON è¡¥ä¸** çš„å¯å¤ç°å®éªŒå¯¹ç…§ã€‚  

è¿™æ˜¯ä¸€ä¸ªæ—¢å¯ç”¨äº **ç§‘ç ”ï¼ˆè®ºæ–‡å®éªŒåŸºå‡†ï¼‰**ï¼Œä¹Ÿå¯ç”¨äº **æ•™å­¦å’Œæœºå™¨äººåº”ç”¨** çš„å¼€æºé¡¹ç›®ã€‚  
